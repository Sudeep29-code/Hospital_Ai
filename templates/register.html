<!DOCTYPE html>
<html>

<head>
    <title>Patient Registration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
        .error-msg {
            color: red;
            font-size: 13px;
            margin-top: 3px;
            display: none;
        }
    </style>

    <script>

        function allowOnlyDigits(input, errorId) {
            input.value = input.value.replace(/\D/g, "");
            document.getElementById(errorId).style.display = "none";
        }

        function copyPhoneToWhatsapp() {
            const phone = document.getElementById("phone").value;
            document.getElementById("whatsapp").value = phone;
        }

        function validateForm() {
            let valid = true;

            const aadhaar = document.getElementById("aadhaar").value;
            const phone = document.getElementById("phone").value;
            const whatsapp = document.getElementById("whatsapp").value;
            const dobInput = document.getElementById("dob");

            // Reset errors
            document.getElementById("aadhaarError").style.display = "none";
            document.getElementById("phoneError").style.display = "none";
            document.getElementById("whatsappError").style.display = "none";
            document.getElementById("dobError").style.display = "none";

            // Aadhaar validation
            if (!/^\d{12}$/.test(aadhaar)) {
                document.getElementById("aadhaarError").style.display = "block";
                valid = false;
            }

            // Phone validation
            if (!/^\d{10}$/.test(phone)) {
                document.getElementById("phoneError").style.display = "block";
                valid = false;
            }

            // WhatsApp validation
            if (whatsapp && !/^\d{10}$/.test(whatsapp)) {
                document.getElementById("whatsappError").style.display = "block";
                valid = false;
            }

            // DOB Validation (0â€“120 years only)
            const dobValue = dobInput.value;
            const today = new Date();
            const dobDate = new Date(dobValue);

            if (!dobValue) {
                document.getElementById("dobError").innerText = "Date of Birth is required";
                document.getElementById("dobError").style.display = "block";
                valid = false;
            }
            else if (dobDate > today) {
                document.getElementById("dobError").innerText = "Date of Birth cannot be in the future";
                document.getElementById("dobError").style.display = "block";
                valid = false;
            }
            else {

                let age = today.getFullYear() - dobDate.getFullYear();
                const monthDiff = today.getMonth() - dobDate.getMonth();

                if (monthDiff < 0 ||
                    (monthDiff === 0 && today.getDate() < dobDate.getDate())) {
                    age--;
                }

                if (age < 0) {
                    document.getElementById("dobError").innerText = "Invalid Date of Birth";
                    document.getElementById("dobError").style.display = "block";
                    valid = false;
                }

                if (age > 120) {
                    document.getElementById("dobError").innerText = "Age cannot be more than 120 years";
                    document.getElementById("dobError").style.display = "block";
                    valid = false;
                }
            }

            return valid;
        }

        document.addEventListener("DOMContentLoaded", function () {

            // ===============================
            // DOB CALENDAR RANGE RESTRICTION
            // ===============================
            const dobInput = document.getElementById("dob");
            const today = new Date();

            function formatDate(date) {
                return date.toISOString().split("T")[0];
            }

            // Max = Today (No future dates visible)
            dobInput.setAttribute("max", formatDate(today));

            // Min = 120 years ago
            const minDate = new Date();
            minDate.setFullYear(today.getFullYear() - 120);
            dobInput.setAttribute("min", formatDate(minDate));

            // ===============================
            // Emergency Department Logic
            // ===============================
            const departmentSelect = document.getElementById("departmentSelect");
            const vitalsSection = document.getElementById("vitalsSection");
            const diseaseSection = document.getElementById("diseaseSection");

            const oxygen = document.getElementById("oxygen");
            const bp = document.getElementById("bp");
            const temperature = document.getElementById("temperature");
            const disease = document.getElementById("disease");

            departmentSelect.addEventListener("change", function () {

                if (this.value === "Emergency") {

                    vitalsSection.style.display = "none";
                    diseaseSection.style.display = "none";

                    oxygen.required = false;
                    bp.required = false;
                    temperature.required = false;
                    disease.required = false;

                    oxygen.disabled = true;
                    bp.disabled = true;
                    temperature.disabled = true;
                    disease.disabled = true;

                    oxygen.value = "";
                    bp.value = "";
                    temperature.value = "";
                    disease.value = "";

                } else {

                    vitalsSection.style.display = "block";
                    diseaseSection.style.display = "block";

                    oxygen.required = true;
                    bp.required = true;
                    temperature.required = true;
                    disease.required = true;

                    oxygen.disabled = false;
                    bp.disabled = false;
                    temperature.disabled = false;
                    disease.disabled = false;
                }
            });
        });

    </script>
</head>

<body>

    <div class="form-container">
        <h1>Patient Registration Form</h1>

        <form method="POST" action="/register" onsubmit="return validateForm()">

            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" required>
            </div>

            <div class="form-group">
                <label>Aadhaar Number</label>
                <input type="text" id="aadhaar" name="aadhaar" maxlength="12" required
                    oninput="allowOnlyDigits(this,'aadhaarError')">
                <div id="aadhaarError" class="error-msg">Aadhaar must be 12 digits</div>
            </div>

            <div class="form-group">
                <label>Gender</label>
                <select name="gender" required>
                    <option value="">Select</option>
                    <option>Male</option>
                    <option>Female</option>
                    <option>Other</option>
                </select>
            </div>

            <div class="form-group">
                <label>Date of Birth</label>
                <input type="date" id="dob" name="dob" required>
                <div id="dobError" class="error-msg"></div>
            </div>

            <div class="form-group">
                <label>Phone Number</label>
                <input type="text" id="phone" name="phone" maxlength="10" required
                    oninput="allowOnlyDigits(this,'phoneError'); copyPhoneToWhatsapp();">
                <div id="phoneError" class="error-msg">Phone must be 10 digits</div>
            </div>

            <div class="form-group">
                <label>WhatsApp Number</label>
                <input type="text" id="whatsapp" name="whatsapp" maxlength="10"
                    oninput="allowOnlyDigits(this,'whatsappError')">
                <div id="whatsappError" class="error-msg">WhatsApp must be 10 digits</div>
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email">
            </div>

            <div class="form-group">
                <label>Blood Group</label>
                <select name="blood_group" required>
                    <option value="">Select Blood Group</option>
                    <option>A+</option>
                    <option>A-</option>
                    <option>B+</option>
                    <option>B-</option>
                    <option>AB+</option>
                    <option>AB-</option>
                    <option>O+</option>
                    <option>O-</option>
                </select>
            </div>

            <div class="form-group">
                <label>Address</label>
                <textarea name="address" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label>Select Department</label>
                <select name="department" id="departmentSelect" required>
                    <option value="">Select Department</option>
                    <option value="General Medicine">General Medicine</option>
                    <option value="Cardiology">Cardiology</option>
                    <option value="Neurology">Neurology</option>
                    <option value="Orthopedics">Orthopedics</option>
                    <option value="Pediatrics">Pediatrics</option>
                    <option value="Emergency">ðŸš¨ Emergency</option>
                </select>
            </div>

            <div id="vitalsSection">

                <div class="section-title">
                    Vital Signs (For Priority Detection)
                </div>

                <div class="form-group">
                    <label>Oxygen Level (SpO2 %)</label>
                    <input type="number" id="oxygen" name="oxygen" min="50" max="100" required>
                </div>

                <div class="form-group">
                    <label>Blood Pressure (Systolic)</label>
                    <input type="number" id="bp" name="bp" min="50" max="200" required>
                </div>

                <div class="form-group">
                    <label>Temperature (Â°C)</label>
                    <input type="number" id="temperature" name="temperature" step="0.1" min="30" max="45" required>
                </div>

            </div>

            <div id="diseaseSection">
                <div class="form-group">
                    <label>Disease / Symptoms</label>
                    <input type="text" id="disease" name="disease" required>
                </div>
            </div>

            <button type="submit">Register & Get Token</button>

        </form>
    </div>

</body>
</html>